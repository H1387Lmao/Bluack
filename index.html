<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bluack Blockly Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/lua_compressed.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    #blocklyDiv {
      flex: 8;
      width: 100%;
    }
    #controls {
      flex: 2;
      width: 100%;
      display: flex;
      flex-direction: column;
      background: #111;
      color: #0f0;
      font-family: monospace;
    }
    #output {
      flex: 1;
      overflow: auto;
      white-space: pre-wrap;
      background: #222;
      padding: 10px;
    }
    #buttons {
      display: flex;
      flex-wrap: wrap;
      padding: 5px;
    }
    button {
      margin: 5px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>
  <div id="blocklyDiv"></div>
  <div id="controls">
    <div id="buttons">
      <button onclick="generateLua()">Generate Lua</button>
    </div>
    <pre id="output">-- Lua code will appear here --</pre>
    <pre id="console"></pre>
  </div>

  <xml id="toolbox" style="display: none">
    <category name="Variables" colour="#A65C81" custom="VARIABLE"></category>
    <category name="Text" colour="#5CA65C">
      <block type="text"></block>
      <block type="text_print"></block>
    </category>
    <category name="Math" colour="#5C68A6">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
    </category>
  </xml>

  <script>
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      scrollbars: true,
      pinch: true,
      trashcan: true
    });

    Blockly.defineBlocksWithJsonArray([
      {
        "type": "start_block",
        "message0": "START",
        "message1": "%1",  // This makes room for the input connection
        "args1": [
          {
            "type": "input_statement",
            "name": "BODY"  // Give it a name!
          }
        ],
        "colour": 0,
        "tooltip": "Program entry point",
        "helpUrl": ""
      }
    ]);

    Blockly.Lua.forBlock['start_block'] = function(block) {
      const next = Blockly.Lua.statementToCode(block, 'BODY') || "";
      return next;
    };
    
    
    // Create START block on workspace load
    const startBlock = workspace.newBlock('start_block');
    startBlock.setDeletable(false);
    startBlock.initSvg();
    startBlock.render();

    function generateLua() {
      try {
        Blockly.Lua.init(workspace);
        const code = Blockly.Lua.blockToCode(startBlock);
        document.getElementById('output').textContent = code;
      } catch (e) {
        document.getElementById('console').textContent = 'Error: ' + e.message;
      }
    }

    window.onerror = function(msg, url, line, col, error) {
      document.getElementById('console').textContent = 'JS Error: ' + msg + ' at line ' + line;
    };
  </script>
</body>
</html>
